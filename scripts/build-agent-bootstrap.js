const fs = require('fs');
const path = require('path');

const base = path.join(__dirname, '..', '.copilot-workflows');
const rulesDir = path.join(base, 'rules');
const out = path.join(base, 'AGENT_BOOTSTRAP.md');

function parseFrontmatter(content) {
  const m = content.match(/^---([\s\S]*?)---/);
  if (!m) return {};
  const lines = m[1].split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const data = {};
  lines.forEach(l => {
    const idx = l.indexOf(':');
    if (idx === -1) return;
    const k = l.slice(0, idx).trim();
    const v = l.slice(idx + 1).trim();
    data[k] = v === 'true' ? true : (v === 'false' ? false : v.replace(/^['"]|['"]$/g, ''));
  });
  return data;
}

function firstParagraph(content) {
  // remove frontmatter
  const m = content.replace(/^---([\s\S]*?)---/, '').trim();
  const lines = m.split(/\r?\n/);
  const para = [];
  for (const ln of lines) {
    if (!ln.trim()) break;
    para.push(ln.trim());
    if (para.length >= 8) break;
  }
  return para.join(' ');
}

const files = fs.readdirSync(rulesDir).filter(f => f.endsWith('.mdc'));
const rules = files.map(f => {
  const p = path.join(rulesDir, f);
  const content = fs.readFileSync(p, 'utf8');
  const fm = parseFrontmatter(content);
  return { file: f, content, frontmatter: fm, excerpt: firstParagraph(content) };
}).filter(r => r.frontmatter.alwaysApply === true);

let outContent = `# AGENT BOOTSTRAP â€” High-priority agent rules\n\n`;
outContent += `This file is an autogenerated summary of high-priority rules (alwaysApply: true) meant to be used as the first line in Copilot Chat prompts. It is intentionally short and prescriptive: paste it into your Chat prompt as the first line to make the assistant follow project policies.\n\n`;

outContent += `---\n\n`;

if (rules.length === 0) {
  outContent += `No rules marked as alwaysApply: true.\n`;
} else {
  rules.forEach(r => {
    outContent += `## ${r.file}\n\n`;
    if (r.frontmatter.description) outContent += `**${r.frontmatter.description}**\n\n`;
    outContent += `${r.excerpt}\n\n`;
    outContent += `Reference: \.copilot-workflows/rules/${r.file}\n\n`;
  });
}

outContent += `---\n\n`;
outContent += `### Usage (copy this single line as the first line in Copilot Chat):\n\n`;
outContent += `Follow \.copilot-workflows/AGENT_BOOTSTRAP.md and then: [your task, e.g. \"Create the first failing test for X\"].\n`;

fs.writeFileSync(out, outContent, 'utf8');
console.log('Wrote', out);
